<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.zerock.api01.rolling.mapper.RollingMapper">
    <sql id="search">
        <bind name="pattern" value="'%' + _parameter.getKeyword() + '%'"/>
        <where>
            1=1
            <if test="type.name() == 'TITLE'">
                and title like #{pattern}
            </if>
            <if test="type.name() == 'TARGET'">
                and target like #{pattern}
            </if>
            <if test="type.name() == 'ALL'">
                and (title like #{pattern}
                or target like #{pattern})
            </if>
        </where>
    </sql>

    <select id="getList"
            parameterType="PageRequestDTO"
            resultType="RollingDTO">
        select *
        from tbl_rolling
        order by rolling_id desc limit #{skip}, #{size}
    </select>

    <select id="getCount" resultType="int">
        select
        count(rolling_id)
        from
        tbl_rolling
        <if test="type!= null">
            <include refid="search"></include>
        </if>
    </select>

    <select id="getRolling"
            parameterType="long"
            resultType="RollingDTO">
        select *
        from tbl_rolling
        where rolling_id = #{id}
    </select>

    <insert id="addRolling"
            parameterType="RollingDTO"
            useGeneratedKeys="true" keyProperty="rollingId">
        insert into tbl_rolling (title, target, img_src, create_dt, writer_member_id)
        value (#{title}, #{target}, #{imgSrc}, #{createDt}, #{writerMemberId})
        <!--        <selectKey keyProperty="rollingId" resultType="long" order="AFTER">-->
        <!--            SELECT LAST_INSERT_ID()-->
        <!--        </selectKey>-->
    </insert>

    <update id="modifyRolling"
            parameterType="RollingDTO">
        update tbl_rolling
        <set>
            <if test="title != null">
                title = #{title},
            </if>
            <if test="target != null">
                target = #{target},
            </if>
            <if test="imgSrc != null">
                img_src = #{imgSrc},
            </if>
        </set>

        where rolling_id = #{rollingId}
    </update>

    <delete id="deleteRolling">
        delete from tbl_rolling where rolling_id = #{rollingId}
    </delete>

</mapper>